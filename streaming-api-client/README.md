Streaming API Script Usage Document
===================================
This sample python script is used to establish a streaming API (acts as Secure WebSocket Client) connection to Aruba Central. Streaming API is subscribe-publish model where a topic is subscribed and Aruba Central will publish data in the intervals or when there are  changes in state. This approach is different from "polling" where requests has to be made using REST APIs continuously in certain intervals, in order to get latest data from Aruba Central. It reduces the number of requests to be made to Aruba Central in order to obtain the information.

 - **Python Version:** Tested with Python 3.6.7
 - **Exporting Data to CSV(Excel) File:** In production, there might be a need to integrate the data to a Database or other storage/monitoring tools. In this Sample script, there is a simple csv exporter. Currently only the data for "presence" topic in streaming API's (proximity message) is exported. For other topics, data will be displayed on screen during execution.
 - **Subscribing to Multiple Topics:** In order to subscribe to multiple topics, multiple websocket connections has to be made. This reference script only creates one websocket connection and can subscribe to only one topic at a time.

### Package Requirements
- See requirements.txt
- Install with:
```sh
pip install -r requirements.txt
```
### Data Format

Data from Aruba Central will be in Google Protocol Buffer format. Most current proto files can be downloaded from the Aruba Central's Streaming API Page. Since the python programming language is used, the python based Google Proto Compiler was used to compile "*.proto" files to "*_pb2.py" files. [Link to compiled pb2 files in ubuntu X64 machine](/streaming-api-client/proto).

Upon running the script, if there are issues in decoding the output in human readable format try re-compiling the file in your machine. More info on compiling proto files [can be found here](https://developers.google.com/protocol-buffers/docs/pythontutorial#compiling-your-protocol-buffers).

## Script Execution

### To Execute the script

```sh
python3 wsclient_public_excel.py --hostname internal-ui.central.arubanetworks.com --jsoninput input.json --subject presence --type streams --do_decode
```

`--hostname` - The base url shown after logging into the Aruba Central. For example "https://**internal-ui.central.arubanetworks.com**/frontend/#/DASHBOARD"

`--jsoninput` - Input File where the Aruba Central customer information is present in JSON format.

`--subject` - One of the following monitoring/apprf/presence/audit

`-type` - One of the following streams/events

`--do_decode` - to decode the message inside streaming data

#### Example of input.json to be supplied in the step1 parameter.
```sh
{
 "customerlist": [[ "< central-account-username >",
                    "< central-wss-key >"
                  ]
                 ],
 "addtofilename": "< any_text_added_to_filename >"
}
```
##### Required:

&nbsp;&nbsp;&nbsp; "central-account-username" --> A valid central user through which Streaming API will be accessed

&nbsp;&nbsp;&nbsp; "central-wss-key" --> obtained from Aruba Central (Maintenance -> Streaming API Page)

##### Optional:

&nbsp;&nbsp;&nbsp;"addtofilename" --> to append a string to autogenerated csv export file name

&nbsp;&nbsp;&nbsp;"filepath" --> if log file has to be created in a certain path(povide absolute path). Defaults to "/logs" in current directory if not provided

### Example data that gets updated to csv file (For presence Topic)

Filename is created in this format `<addtofilename>_<stream_type>_<timestamp>.<filetype>`

&nbsp;&nbsp;&nbsp;test_4qWmUJFI5OpV14eR2RfCdTqGK_presence_20190417-142654.csv
```
timestamp,customer_id,event,device_id,sta_eth_mac,radio_mac,rssi_val,noise_floor,associated
1555536367929,5001XXX,presence,CK01xxxxx,E0F8471EXXXX,04BD8862XXXX,-61,0,True
1555536425946,5001XXX,presence,DN00xxxxx,7C5CF88FXXXX,40E3D60AXXXX,-86,0,False
1555536425946,5001XXX,presence,DN00xxxxx,F83441C4XXXX,40E3D60AXXXX,-83,0,False
1555536425946,5001XXX,presence,DN00xxxxx,40ED9852XXXX,40E3D60AXXXX,-56,0,False
1555536425946,5001XXX,presence,DN00xxxxx,F83441C8XXXX,40E3D60AXXXX,-74,0,False
```
